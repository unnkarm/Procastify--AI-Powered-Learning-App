rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection - users can read/write their own profile
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
      
      // User subcollections (notes, summaries, quizzes, etc.)
      match /{subcollection}/{docId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Notes collection (root level)
    match /notes/{noteId} {
      // Read: Owner, or public notes, or students in classrooms where note is shared
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.userId == request.auth.uid ||
        resource.data.isPublic == true
      );
      
      // Create: Only authenticated users can create their own notes
      allow create: if isAuthenticated() && (
        request.resource.data.ownerId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
      
      // Update/Delete: Only the owner
      allow update, delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // Folders collection
    match /folders/{folderId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Classrooms collection
    match /classrooms/{classroomId} {
      // Teachers can read their own classrooms
      // Students can read classrooms they're enrolled in
      allow read: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        request.auth.uid in resource.data.studentIds
      );
      
      // Only teachers can create their own classrooms
      allow create: if isAuthenticated() && 
        request.resource.data.teacherId == request.auth.uid;
      
      // Teachers can update their own classrooms
      // Students can update ONLY to add themselves to studentIds (when accepting invitation)
      allow update: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        (
          // Student can only add themselves to studentIds array
          request.auth.uid in request.resource.data.studentIds &&
          !(request.auth.uid in resource.data.studentIds) &&
          // Ensure they're only modifying studentIds and updatedAt
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['studentIds', 'updatedAt'])
        )
      );
      
      // Only teachers can delete their own classrooms
      allow delete: if isAuthenticated() && 
        resource.data.teacherId == request.auth.uid;
      
      // Announcements subcollection
      match /announcements/{announcementId} {
        // Anyone in the classroom can read announcements
        allow read: if isAuthenticated() && (
          get(/databases/$(database)/documents/classrooms/$(classroomId)).data.teacherId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/classrooms/$(classroomId)).data.studentIds
        );
        
        // Only the classroom teacher can write announcements
        allow write: if isAuthenticated() && 
          get(/databases/$(database)/documents/classrooms/$(classroomId)).data.teacherId == request.auth.uid;
      }
      
      // Resources subcollection
      match /resources/{resourceId} {
        // Anyone in the classroom can read resources
        allow read: if isAuthenticated() && (
          get(/databases/$(database)/documents/classrooms/$(classroomId)).data.teacherId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/classrooms/$(classroomId)).data.studentIds
        );
        
        // Only the classroom teacher can write resources
        allow write: if isAuthenticated() && 
          get(/databases/$(database)/documents/classrooms/$(classroomId)).data.teacherId == request.auth.uid;
      }
      
      // Activities subcollection
      match /activities/{activityId} {
        // Teachers can read activities from their classrooms
        // Students can read activities from classrooms they're enrolled in
        allow read: if isAuthenticated() && (
          get(/databases/$(database)/documents/classrooms/$(classroomId)).data.teacherId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/classrooms/$(classroomId)).data.studentIds
        );
        
        // Teachers and students can create activities (for logging their actions)
        // Teachers: announcements, resource sharing
        // Students: joining, accepting invitations, copying resources
        allow create: if isAuthenticated() && (
          get(/databases/$(database)/documents/classrooms/$(classroomId)).data.teacherId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/classrooms/$(classroomId)).data.studentIds
        );
        
        // Only teachers can update/delete activities
        allow update, delete: if isAuthenticated() && 
          get(/databases/$(database)/documents/classrooms/$(classroomId)).data.teacherId == request.auth.uid;
      }
    }
    
    // Invitations collection
    match /invitations/{invitationId} {
      // Teachers can read invitations for their classrooms
      // Students can read invitations sent to their email
      allow read: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        request.auth.token.email == resource.data.studentEmail
      );
      
      // Only teachers can create invitations for their classrooms
      allow create: if isAuthenticated() && 
        request.resource.data.teacherId == request.auth.uid;
      
      // Teachers can update their invitations
      // Students can update invitations sent to them (to accept/decline)
      allow update: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        request.auth.token.email == resource.data.studentEmail
      );
      
      // Only teachers can delete invitations
      allow delete: if isAuthenticated() && 
        resource.data.teacherId == request.auth.uid;
    }
    
    // Study Resources collection
    match /studyResources/{resourceId} {
      // Anyone can read study resources (public access)
      allow read: if true;
      
      // Only authenticated users can create resources
      allow create: if isAuthenticated() && 
        request.resource.data.ownerId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid;
      
      // Only the owner can update their resources
      allow update: if isAuthenticated() && 
        resource.data.ownerId == request.auth.uid &&
        request.resource.data.ownerId == request.auth.uid;
      
      // Only the owner can delete their resources
      allow delete: if isAuthenticated() && 
        resource.data.ownerId == request.auth.uid;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}